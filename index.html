<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>デザイン案件管理</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter (Optional, but recommended for consistent design) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>

    <!-- Firebase Configuration - REPLACE WITH YOUR ACTUAL FIREBASE PROJECT CONFIG -->
    <!-- !!! IMPORTANT: You MUST replace "YOUR_API_KEY", "YOUR_AUTH_DOMAIN", etc. with your actual Firebase project values. -->
    <!-- You can find these values in your Firebase Console under Project settings > General. -->
    <script>
        window.__firebase_config = {
            apiKey: "YOUR_API_KEY", // <-- ここをあなたのAPIキーに置き換えてください
            authDomain: "YOUR_AUTH_DOMAIN", // 例: your-project-id.firebaseapp.com
            projectId: "YOUR_PROJECT_ID", // 例: your-project-id
            storageBucket: "YOUR_STORAGE_BUCKET", // 例: your-project-id.appspot.com
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID" // 例: 1:xxxxxxxxxx:web:xxxxxxxxxxxxxx
        };
        window.__app_id = "YOUR_APP_ID"; // 通常はwindow.__firebase_config.appIdと同じ
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <!-- window.firebaseオブジェクトを構築するスクリプトを先に実行 -->
    <script type="module">
        // Firebaseモジュールをインポートし、window.firebaseオブジェクトに公開
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp,
            doc,
            updateDoc,
            arrayUnion
        };
    </script>

    <!-- React and ReactDOM from CDN -->
    <!-- These are global, so no import needed in App.js -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Your App.js script content directly embedded here -->
    <script type="text/babel">
        // Reactはグローバルスコープからアクセス可能になる
        const { useState, useEffect, useCallback, useRef, useMemo } = React;


        // TimelineBarコンポーネント
        const TimelineBar = ({ startDate, dueDate, status, events = [] }) => {
          if (!startDate || !dueDate) {
            return <div className="text-gray-500 text-xs">日付未設定</div>;
          }

          const start = new Date(startDate);
          const end = new Date(dueDate);
          const today = new Date();

          start.setHours(0, 0, 0, 0);
          end.setHours(0, 0, 0, 0);
          today.setHours(0, 0, 0, 0);

          const totalDurationMs = end.getTime() - start.getTime();

          // ツールチップ表示用のstate
          const [activeTooltipIndex, setActiveTooltipIndex] = useState(null);
          const [showStartTooltip, setShowStartTooltip] = useState(false);
          const [showEndTooltip, setShowEndTooltip] = useState(false);


          // イベントの種類に応じた色を返すヘルパー関数
          const getEventTypeColor = (event) => { // イベントオブジェクト全体を受け取る
            if (event.completed) {
              return 'bg-green-500'; // 完了したイベントは常に緑
            }
            switch (event.type) {
              case '予定': return 'bg-yellow-500';
              case '提出': return 'bg-yellow-500'; // '予定'から'提出'に変更
              case 'タスク': return 'bg-red-500';
              case '完了': return 'bg-green-500'; // '完了'タイプの未完了イベントも緑
              default: return 'bg-purple-600'; // デフォルト色 (未定義の場合)
            }
          };

          // イベントマーカーの位置を計算
          const eventMarkers = events
            .map((event) => {
              const eventDate = new Date(event.date);
              eventDate.setHours(0, 0, 0, 0);
              const eventOffsetMs = eventDate.getTime() - start.getTime();
              let position = 0;
              if (totalDurationMs > 0) {
                position = (eventOffsetMs / totalDurationMs) * 100;
              }
              return {
                ...event,
                position: Math.max(0, Math.min(100, position))
              };
            })
            .sort((a, b) => a.position - b.position); // 位置でソート

          let progressPercentage = 0;
          if (totalDurationMs > 0) {
            const elapsedMs = today.getTime() - start.getTime();
            progressPercentage = (elapsedMs / totalDurationMs) * 100;
            if (progressPercentage < 0) progressPercentage = 0;
            if (progressPercentage > 100) progressPercentage = 100;
          }

          const barColorClass = 'bg-gray-700'; // Dark gray, close to black
          const progressColorClass = status === '完了' ? 'bg-blue-500' : 'bg-green-500';

          // 今日のマーカーの位置を計算
          const todayMarkerPosition = (today.getTime() - start.getTime()) / totalDurationMs * 100;
          let clampedTodayMarkerPosition = Math.max(0, Math.min(100, todayMarkerPosition));

          return (
            <div className="relative w-full h-8 rounded-lg my-1">
              {/* ベースの薄い黒い線 */}
              <div
                className={`absolute top-1/2 -translate-y-1/2 left-0 h-0.5 ${barColorClass} w-full rounded-lg`}
              ></div>

              {/* 進捗バー (緑/青) */}
              {status !== '完了' && (
                <div
                  className={`absolute top-1/2 -translate-y-1/2 left-0 h-0.5 ${progressColorClass} transition-all duration-500 ease-out rounded-lg`}
                  style={{ width: `${progressPercentage}%` }}
                ></div>
              )}

              {/* 今日のマーカー (▼) - ラインの上に表示、黒色 */}
              <div
                className="absolute bottom-full mb-1 h-0 w-0 border-l-[6px] border-r-[6px] border-t-[8px] border-l-transparent border-r-transparent border-t-black z-10"
                style={{ left: `${clampedTodayMarkerPosition}%`, transform: 'translateX(-50%)' }} // 中央に配置
                title="今日"
              ></div>

              {/* 開始日のマーカー */}
              <div
                className="absolute top-1/2 -translate-y-1/2 w-3 h-3 z-20 cursor-pointer"
                style={{ left: `0%`, transform: 'translateX(-50%)' }}
                onMouseEnter={() => setShowStartTooltip(true)}
                onMouseLeave={() => setShowStartTooltip(false)}
              >
                <div className="absolute left-1/2 -translate-x-1/2 w-0.5 h-4 bg-gray-800 -top-2"></div> {/* Vertical line */}
                <div className="absolute left-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-gray-800 -top-4"></div> {/* Small circle */}
                {showStartTooltip && (
                  <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap z-30">
                    <p>開始日: {startDate}</p>
                    <div className="absolute bottom-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-4 border-b-gray-800"></div>
                  </div>
                )}
              </div>

              {/* 完了予定日のマーカー */}
              <div
                className="absolute top-1/2 -translate-y-1/2 w-3 h-3 z-20 cursor-pointer"
                style={{ left: `100%`, transform: 'translateX(-50%)' }}
                onMouseEnter={() => setShowEndTooltip(true)}
                onMouseLeave={() => setShowEndTooltip(false)}
              >
                <div className="absolute left-1/2 -translate-x-1/2 w-0.5 h-4 bg-gray-800 -top-2"></div> {/* Vertical line */}
                <div className="absolute left-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-gray-800 -top-4"></div> {/* Small circle */}
                {showEndTooltip && (
                  <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap z-30">
                    <p>完了予定日: {dueDate}</p>
                    <div className="absolute bottom-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-4 border-b-gray-800"></div>
                  </div>
                )}
              </div>

              {/* イベントマーカー */}
              {eventMarkers.map((event, index) => (
                <div
                  key={index}
                  // タスクの場合は四角、それ以外は丸
                  className={`absolute top-1/2 -translate-y-1/2 w-3 h-3 z-20 cursor-pointer ${getEventTypeColor(event)} ${event.type === 'タスク' ? '' : 'rounded-full'}`}
                  style={{ left: `${event.position}%` }}
                  onMouseEnter={() => setActiveTooltipIndex(index)}
                  onMouseLeave={() => setActiveTooltipIndex(null)}
                  onClick={() => setActiveTooltipIndex(activeTooltipIndex === index ? null : index)} // タップで表示・非表示を切り替え
                >
                  {/* ツールチップ */}
                  {activeTooltipIndex === index && (
                    <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap z-30">
                      <p>{event.date}</p>
                      <p>{event.description}</p>
                      {event.pdfUrl && (
                        <p className="text-xs text-gray-400">
                          PDF: <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-300 hover:underline">表示</a>
                        </p>
                      )}
                      {/* ツールチップのポインター（吹き出しの三角形） */}
                      <div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-4 border-t-gray-800"></div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          );
        };

        // New component for vertical timeline for a single case
        const VerticalCaseTimeline = ({ caseItem, displayStartDate, displayEndDate, heightPerDay, openEditPage, onCaseHover }) => {
          const caseStartDate = new Date(caseItem.startDate);
          const caseDueDate = new Date(caseItem.dueDate);

          // Clamp case start/end dates to display range for visual representation
          const effectiveStartDate = new Date(Math.max(caseStartDate.getTime(), displayStartDate.getTime()));
          const effectiveDueDate = new Date(Math.min(caseDueDate.getTime(), displayEndDate.getTime()));

          // Calculate top position relative to the overall display start date
          const startOffsetDays = (effectiveStartDate.getTime() - displayStartDate.getTime()) / (1000 * 60 * 60 * 24);
          const topPx = Math.max(0, startOffsetDays * heightPerDay);

          // Calculate height based on effective duration within the display range
          const durationDays = (effectiveDueDate.getTime() - effectiveStartDate.getTime()) / (1000 * 60 * 60 * 24) + 1;
          const heightPx = Math.max(0, durationDays * heightPerDay);

          if (heightPx <= 0) return null;

          const sortedEvents = [...(caseItem.events || [])].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

          const getEventTypeShapeClass = (event) => {
            switch (event.type) {
              case 'タスク': return ''; // Square for task
              default: return 'rounded-full'; // Circle for others
            }
          };

          const getEventColorClass = (event) => {
            if (event.completed) {
              return 'bg-green-500';
            }
            switch (event.type) {
              case '予定': return 'bg-yellow-500';
              case '提出': return 'bg-yellow-500'; // '予定'から'提出'に変更
              case 'タスク': return 'bg-red-500';
              case '完了': return 'bg-green-500';
              default: return 'bg-purple-600';
            }
          };

          const [activeTooltipIndex, setActiveTooltipIndex] = useState(null); // For event tooltips

          return (
            <div
              className="absolute w-0.5 bg-gray-800 flex flex-col items-center cursor-pointer" // 黒の細い線に変更, cursor-pointerを追加
              style={{ top: `${topPx}px`, height: `${heightPx}px`, /* Horizontal positioning will be handled by parent */ }}
              onClick={() => openEditPage(caseItem)} // 黒ライン全体をクリック可能に
              onMouseEnter={() => onCaseHover(caseItem)} // マウスオーバーで案件情報を親に渡す
              onMouseLeave={() => onCaseHover(null)} // マウスアウトで情報をクリア
            >
              {/* 開始日マーカー (ツールチップなし) */}
              <div
                className="absolute w-3 h-3 bg-black rounded-full z-20"
                style={{ top: '0px', transform: 'translateY(-50%) translateX(-50%)', left: '50%' }}
              ></div>

              {/* 完了予定日マーカー (ツールチップなし) */}
              <div
                className="absolute w-3 h-3 bg-black rounded-full z-20"
                style={{ bottom: '0px', transform: 'translateY(50%) translateX(-50%)', left: '50%' }}
              ></div>

              {/* Events on this case's timeline */}
              {sortedEvents.map((event, eventIdx) => {
                const eventDate = new Date(event.date);
                // Position event relative to the effective start date of the case's visible timeline
                const eventOffsetDays = (eventDate.getTime() - effectiveStartDate.getTime()) / (1000 * 60 * 60 * 24);
                const eventTopPx = eventOffsetDays * heightPerDay;

                // Only show event if it.falls within the visible portion of the case timeline
                if (eventTopPx < 0 || eventTopPx > heightPx) return null;

                return (
                  <div
                    key={eventIdx}
                    className={`absolute w-3 h-3 z-20 cursor-pointer ${getEventColorClass(event)} ${getEventTypeShapeClass(event)}`} // 形状と色を適用
                    style={{ top: `${eventTopPx}px`, left: '50%', transform: 'translateX(-50%) translateY(-50%)' }} // 線の上に中央配置
                    onMouseEnter={() => setActiveTooltipIndex(eventIdx)}
                    onMouseLeave={() => setActiveTooltipIndex(null)}
                  >
                    {/* ツールチップ */}
                    {activeTooltipIndex === eventIdx && (
                      <div className="absolute left-1/2 -translate-x-1/2 mt-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap z-30" style={{ top: '100%' }}>
                        <p>{event.date}</p>
                        <p>{event.description}</p>
                        {event.pdfUrl && (
                          <p className="text-xs text-gray-400">
                            PDF: <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-300 hover:underline">表示</a>
                          </p>
                        )}
                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-4 border-b-gray-800"></div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          );
        };


        const ListCalendarView = ({ cases, openEditPage }) => { // openEditPage を受け取る
          const scrollContainerRef = useRef(null);
          const heightPerDay = 20; // 1日あたりの高さ (px)を20pxに変更
          const [loadedDaysBefore, setLoadedDaysBefore] = useState(15); // 今日から過去に読み込む日数
          const [loadedDaysAfter, setLoadedDaysAfter] = useState(15);  // 今日から未来に読み込む日数
          const loadIncrement = 30; // 一度に読み込む日付の増分
          const [hoveredCaseInfo, setHoveredCaseInfo] = useState(null); // ホバー中の案件情報を保持するstate

          const today = useMemo(() => { // todayをメモ化
            const d = new Date();
            d.setHours(0, 0, 0, 0);
            return d;
          }, []);

          // 表示開始日と表示終了日を計算 (useMemoでメモ化)
          const displayStartDate = useMemo(() => {
            const d = new Date(today);
            d.setDate(today.getDate() - loadedDaysBefore);
            return d;
          }, [today, loadedDaysBefore]);

          const displayEndDate = useMemo(() => {
            const d = new Date(today);
            d.setDate(today.getDate() + loadedDaysAfter);
            return d;
          }, [today, loadedDaysAfter]);

          const datesToDisplay = useMemo(() => {
            const dates = [];
            let loopDate = new Date(displayStartDate);
            while (loopDate <= displayEndDate) {
              dates.push(new Date(loopDate));
              loopDate.setDate(loopDate.getDate() + 1);
            }
            return dates;
          }, [displayStartDate, displayEndDate]); // Dependencies for useMemo

          const totalContentHeight = datesToDisplay.length * heightPerDay; // 全日付のコンテンツに必要な合計高さ

          // ファーストビューで表示したい日数を設定
          const firstViewDays = 31; // 31日をファーストビューで表示
          const firstViewHeight = firstViewDays * heightPerDay; // 31日分の高さ

          // 初期ロード時に今日の日付が中央に来るようにスクロール
          useEffect(() => {
            if (scrollContainerRef.current) {
              const todayIndex = datesToDisplay.findIndex(date => date.toDateString() === today.toDateString());
              if (todayIndex !== -1) {
                // 今日がスクロールコンテナの中央に来るように計算
                const scrollToY = (todayIndex * heightPerDay) - (scrollContainerRef.current.clientHeight / 2) + (heightPerDay / 2);
                scrollContainerRef.current.scrollTop = Math.max(0, scrollToY);
              }
            }
          }, [datesToDisplay, today, heightPerDay, firstViewHeight]);

          // スクロールイベントハンドラ
          const handleScroll = useCallback(() => {
            const { scrollTop, scrollHeight, clientHeight } = scrollContainerRef.current;
            const scrollThreshold = 50; // スクロール端からの距離（px）

            // 上端にスクロールしたか
            if (scrollTop < scrollThreshold) {
              const oldScrollHeight = scrollHeight;
              setLoadedDaysBefore(prev => prev + loadIncrement);
              // 新しいコンテンツが追加された後にスクロール位置を調整
              requestAnimationFrame(() => {
                if (scrollContainerRef.current) {
                  scrollContainerRef.current.scrollTop = scrollContainerRef.current.scrollHeight - oldScrollHeight;
                }
              });
            }

            // 下端にスクロールしたか
            if (scrollTop + clientHeight > scrollHeight - scrollThreshold) {
              setLoadedDaysAfter(prev => prev + loadIncrement);
            }
          }, [loadIncrement]);

          // スクロールイベントリスナーの追加とクリーンアップ
          useEffect(() => {
            const currentRef = scrollContainerRef.current;
            if (currentRef) {
              currentRef.addEventListener('scroll', handleScroll);
            }
            return () => {
              if (currentRef) {
                currentRef.removeEventListener('scroll', handleScroll);
              }
            };
          }, [handleScroll]);


          // Filter cases that have a valid date range, overlap with the display range, and are not '完了'
          const visibleCases = cases.filter(caseItem =>
            caseItem.startDate && caseItem.dueDate &&
            new Date(caseItem.dueDate) >= displayStartDate &&
            new Date(caseItem.startDate) <= displayEndDate &&
            caseItem.status !== '完了' // '完了'ステータスの案件を除外
          );

          // カレンダー表示の横幅を動的に計算
          const dateColumnWidth = 96; // w-24 = 96px
          const caseColumnWidth = 100; // 各案件の縦ラインが占める幅 (詳細ボタン含む)
          const minContentWidth = dateColumnWidth + (visibleCases.length * caseColumnWidth) + 50; // 案件数に応じて幅を調整 + パディング

          // 日付をYY.MM/DD形式でフォーマットするヘルパー関数
          const formatDateToYYMMDD = (date) => {
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}.${month}/${day}`;
          };

          // ホバーイベントハンドラ
          const handleCaseHover = (caseItem) => {
            setHoveredCaseInfo(caseItem);
          };

          return (
            <div className="p-6 bg-white rounded-xl shadow-md">
              <h2 className="text-2xl font-semibold text-gray-700 mb-4 text-center">カレンダー表示 (縦型タイムライン)</h2>

              {/* メインのスクロールコンテナ */}
              <div
                ref={scrollContainerRef}
                className="relative flex-grow overflow-y-scroll overflow-x-auto border border-gray-200 rounded-lg" // スクロールを統合
                style={{ maxHeight: `${firstViewHeight}px` }}
              >
                <div className="relative" style={{ minHeight: `${totalContentHeight}px`, minWidth: `${minContentWidth}px` }}> {/* 全コンテンツのラッパー */}

                  {/* Date Labels and Horizontal Lines */}
                  {datesToDisplay.map((date, index) => {
                    const isToday = date.toDateString() === today.toDateString();
                    const topPosition = index * heightPerDay;
                    return (
                      <div
                        key={date.toISOString()} // ユニークなキーとしてISO文字列を使用
                        className={`absolute w-full flex items-center border-b border-gray-200 ${isToday ? 'bg-red-50' : ''}`}
                        style={{ top: `${topPosition}px`, height: `${heightPerDay}px` }}
                      >
                        {/* Date label */}
                        <div className={`w-24 text-xs text-center flex-shrink-0 ${isToday ? 'font-bold text-blue-700' : 'text-gray-600'}`}>
                          {formatDateToYYMMDD(date)}
                        </div>
                        {/* 案件のタイムラインが表示される領域 (右側) は、この行の残りの部分に暗黙的に含まれる */}
                      </div>
                    );
                  })}

                  {/* Render each case's vertical timeline */}
                  {visibleCases.map((caseItem, index) => {
                    // Calculate horizontal offset for each case timeline to avoid overlap
                    const dateColumnWidth = 96; // w-24 = 96px
                    const horizontalOffset = index * caseColumnWidth; // 各案件に100px幅の"トラック"を割り当て
                    const adjustedLeft = dateColumnWidth + horizontalOffset + 20; // 日付列の幅 + 案件トラック + パディング

                    return (
                      <div
                        key={caseItem.id}
                        className="absolute"
                        style={{
                          left: `${adjustedLeft}px`,
                          width: `${caseColumnWidth}px`, // 案件名を表示するために親の幅を確保
                          height: '100%', // 親スクロールエリアの全高を取る
                        }}
                      >
                        <VerticalCaseTimeline
                          caseItem={caseItem}
                          displayStartDate={displayStartDate}
                          displayEndDate={displayEndDate}
                          heightPerDay={heightPerDay}
                          openEditPage={openEditPage}
                          onCaseHover={handleCaseHover} // ホバーイベントを親に伝える
                        />
                        {/* Removed 案件名を欄外の枠の左下に表示 from here */}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* ホバーされた案件情報を表示するエリア */}
              <div className="mt-4 p-3 bg-gray-100 rounded-lg border border-gray-200 w-full text-left">
                {hoveredCaseInfo ? (
                  <div className="text-gray-800 text-sm">
                    <p className="font-semibold">案件名: {hoveredCaseInfo.name}</p>
                    <p>開始日: {hoveredCaseInfo.startDate || '-'}</p>
                    <p>完了予定日: {hoveredCaseInfo.dueDate || '-'}</p>
                    <p>ステータス: {hoveredCaseInfo.status}</p>
                  </div>
                ) : (
                  <p className="text-gray-500 text-sm">案件ラインにマウスを合わせると詳細が表示されます。</p>
                )}
              </div>
            </div>
          );
        };


        function App() {
          // Firebase関連のstate
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [userId, setUserId] = useState('');
          const [isAuthReady, setIsAuthReady] = useState(false);
          // const [isLoggedIn, setIsLoggedIn] = useState(false); // Removed state for login status


          // Case data and input form state
          const [cases, setCases] = useState([]);
          const [newCaseName, setNewCaseName] = useState('');
          const [newAssignee, setNewAssignee] = useState('');
          const [newStatus, setNewStatus] = useState('未着手'); // Default status
          const [newStartDate, setNewStartDate] = useState(''); // Start Date
          const [newDueDate, setNewDueDate] = useState('');
          const [newBasePrice, setNewBasePrice] = useState(''); // 修正: useStateで初期化
          // const [newRevisionCount, setNewRevisionCount] = useState(0); // Revision Count - 削除
          // const [newDifficulty, setNewDifficulty] = useState('中'); // Design Difficulty - 削除
          const [newPdfUrl, setNewPdfUrl] = useState(''); // PDF URL (for main case) - Added useState for proper initialization
          const [newEvents, setNewEvents] = useState([]); // New timeline events
          const [newEventDate, setNewEventDate] = useState('');
          const [newEventDescription, setNewEventDescription] = useState(''); // 修正: useStateで初期化
          const [newEvent_Type, setNewEvent_Type] = useState('提出'); // New: for event type selection - '予定'から'提出'に変更
          const [newEventPdfUrl, setNewEventPdfUrl] = useState(''); // 修正: useStateで初期化

          const [loading, setLoading] = useState(true);
          const [error, setError] = useState(null);

          // Edit modal related state
          const [isEditModalOpen, setIsEditModalOpen] = useState(false); // This state is no longer used for full-screen edit, but kept for clarity if modal was reintroduced
          const [editingCase, setEditingCase] = useState(null);
          const [editedCaseName, setEditedCaseName] = useState(''); // 修正: useStateで初期化
          const [editedAssignee, setEditedAssignee] = useState(''); // 修正: useStateで初期化
          const [editedStatus, setEditedStatus] = useState(''); // 修正: useStateで初期化
          const [editedStartDate, setEditedStartDate] = useState(''); // 修正: useStateで初期化 - Added useState for proper initialization
          const [editedDueDate, setEditedDueDate] = useState(''); // 修正: useStateで初期化 - Added useState for proper initialization
          const [editedBasePrice, setEditedBasePrice] = useState(''); // 修正: useStateで初期化
          // const [editedRevisionCount, setEditedRevisionCount] = useState(0); // Revision Count - 削除
          // const [editedDifficulty, setEditedDifficulty] = ''; // 修正: useStateで初期化 - 削除
          const [editedPdfUrl, setEditedPdfUrl] = useState(''); // 修正: useStateで初期化
          const [editedEvents, setEditedEvents] = useState([]); // Timeline events being edited


          // New state for managing the current application view: 'list' or 'edit'
          const [currentView, setCurrentView] = useState('list'); // 'list' or 'edit'

          // State for managing the display mode within the list view: 'card', 'table', or 'timeline', 'calendar'
          const [listDisplayMode, setListDisplayMode] = useState('calendar'); // 'card', 'table', 'timeline', 'calendar'


          // Custom alert state
          const [showAlert, setShowAlert] = useState(false);
          const [alertMessage, setAlertMessage] = useState(''); // 修正: useStateで初期化

          // Function to show custom alert
          const showCustomAlert = (message) => {
            setAlertMessage(message);
            setShowAlert(true);
          };

          // Firebase initialization and authentication
          useEffect(() => {
            try {
              // Firebase設定とアプリIDをグローバルスコープから取得
              let firebaseConfig;
              if (typeof __firebase_config === 'string' && __firebase_config.trim() !== '') {
                  firebaseConfig = JSON.parse(__firebase_config);
              } else if (typeof __firebase_config === 'object' && __firebase_config !== null) {
                  firebaseConfig = __firebase_config;
              } else {
                  firebaseConfig = {}; // デフォルトの空オブジェクト
              }

              // Log the Firebase config to help with debugging
              console.log("Firebase config loaded:", firebaseConfig);

              const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

              // window.firebase が利用可能か確認
              if (!window.firebase) {
                throw new Error("window.firebase is not defined. Firebase SDKs might not have loaded correctly.");
              }

              const app = window.firebase.initializeApp(firebaseConfig);
              const firestoreDb = window.firebase.getFirestore(app);
              const firebaseAuth = window.firebase.getAuth(app);

              setDb(firestoreDb);
              setAuth(firebaseAuth);

              const unsubscribe = window.firebase.onAuthStateChanged(firebaseAuth, async (user) => {
                if (!user) {
                  // If no user is logged in (or after logout), sign in anonymously
                  try {
                    await window.firebase.signInAnonymously(firebaseAuth);
                  } catch (authError) {
                    console.error("Firebase anonymous authentication failed:", authError);
                    setError("匿名認証に失敗しました。Firebaseコンソールで匿名認証を有効にしてください。"); // エラーメッセージを具体化
                  }
                }
                const currentUserId = firebaseAuth.currentUser?.uid || crypto.randomUUID();
                setUserId(currentUserId); // Ensure userId is always set
                console.log("Current Firebase User ID:", currentUserId); // ★追加: ユーザーIDをコンソールに出力
                setIsAuthReady(true);
                setLoading(false); // Set loading to false after auth state is determined
              });

              return () => unsubscribe();
            } catch (err) {
              console.error("Firebase initialization error:", err);
              setError("Firebaseの初期化に失敗しました。"); // エラーメッセージを具体化
              setLoading(false);
            }
          }, []);

          // Real-time fetching of case data
          useEffect(() => {
            if (db && isAuthReady && userId) {
              setError(null);
              const casesCollectionRef = window.firebase.collection(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/cases`);
              // orderBy() might require an index, so we sort after fetching
              const q = window.firebase.query(casesCollectionRef);

              const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                const fetchedCases = snapshot.docs.map(doc => ({
                  id: doc.id,
                  ...doc.data()
                }));
                // Sort by creation date (newest first)
                fetchedCases.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                setCases(fetchedCases);
              }, (err) => {
                console.error("Error fetching cases:", err);
                setError("案件データの取得に失敗しました。");
              });

              return () => unsubscribe();
            }
          }, [db, isAuthReady, userId]);


          // Add a new case
          const handleAddCase = async () => {
            if (!newCaseName.trim() || !newAssignee.trim() || !db) {
              showCustomAlert('案件名と担当者は必須です。');
              return;
            }
            try {
              const casesCollectionRef = window.firebase.collection(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/cases`);
              await window.firebase.addDoc(casesCollectionRef, {
                name: newCaseName,
                assignee: newAssignee,
                status: newStatus,
                startDate: newStartDate,
                dueDate: newDueDate,
                basePrice: newBasePrice ? parseFloat(newBasePrice) : 0, // Convert to number
                pdfUrl: newPdfUrl, // Main case PDF URL
                events: newEvents, // Events now include completed status, pdfUrl, and imageUrl from local state
                createdAt: window.firebase.serverTimestamp(),
                createdBy: userId
              });
              setNewCaseName('');
              setNewAssignee('');
              setNewStatus('未着手');
              setNewStartDate('');
              setNewDueDate('');
              setNewBasePrice('');
              setNewPdfUrl('');
              setNewEvents([]); // Clear event list
              setNewEventDate(''); // Clear
              setNewEventDescription(''); // Clear
              setNewEvent_Type('提出'); // Reset type - '予定'から'提出'に変更
              setNewEventPdfUrl(''); // Clear event PDF URL
            } catch (e) {
              console.error("Error adding document: ", e);
              setError("案件の追加に失敗しました。");
            }
          };

          // Add event to new case form (local state only)
          const handleAddNewEvent = () => {
            if (newEventDate && newEventDescription && newEvent_Type) {
              setNewEvents([...newEvents, { date: newEventDate, description: newEventDescription, type: newEvent_Type, pdfUrl: newEventPdfUrl, completed: false }]);
              setNewEventDate('');
              setNewEventDescription('');
              setNewEvent_Type('提出'); // Reset to default - '予定'から'提出'に変更
              setNewEventPdfUrl(''); // Clear event PDF URL
            } else {
              showCustomAlert('イベントの日付、内容、種類は必須です。');
            }
          };

          // Remove event from new case form (local state only)
          const handleRemoveNewEvent = (indexToRemove) => {
            setNewEvents(newEvents.filter((_, i) => i !== indexToRemove));
          };

          // Toggle completion for event in new case form (local state only)
          const handleToggleNewEventCompletion = (indexToToggle) => {
            const updatedEvents = [...newEvents];
            if (updatedEvents[indexToToggle]) {
              updatedEvents[indexToToggle].completed = !updatedEvents[indexToToggle].completed;
              setNewEvents(updatedEvents);
            }
          };


          // Function to open case edit page (full screen)
          const openEditPage = (caseItem) => {
            setEditingCase(caseItem);
            setEditedCaseName(caseItem.name);
            setEditedAssignee(caseItem.assignee);
            setEditedStatus(caseItem.status);
            setEditedStartDate(caseItem.startDate || '');
            setEditedDueDate(caseItem.dueDate || '');
            setEditedBasePrice(caseItem.basePrice || '');
            setEditedPdfUrl(caseItem.pdfUrl || '');
            setEditedEvents(caseItem.events || []);
            setNewEventDate(''); // Clear for new input in edit page
            setNewEventDescription(''); // Clear for new input in edit page
            setNewEvent_Type('提出'); // Reset type for new input in edit page - '予定'から'提出'に変更
            setNewEventPdfUrl(''); // Clear event PDF URL for new input in edit page
            setCurrentView('edit'); // Change view to 'edit'
          };

          // Function to close edit page and return to list view
          const closeEditPage = () => {
            setCurrentView('list'); // Change view back to 'list'
            setEditingCase(null); // Clear editing case
          };


          // Add event to edited case (local state only)
          const handleAddEditedEvent = () => {
            if (newEventDate && newEventDescription && newEvent_Type) {
              setEditedEvents([...editedEvents, { date: newEventDate, description: newEventDescription, type: newEvent_Type, pdfUrl: newEventPdfUrl, completed: false }]);
              setNewEventDate('');
              setNewEventDescription('');
              setNewEvent_Type('提出'); // Reset to default - '予定'から'提出'に変更
              setNewEventPdfUrl(''); // Clear event PDF URL
            } else {
              showCustomAlert('イベントの日付、内容、種類は必須です。');
            }
          };

          // Remove event from edited case (local state only)
          const handleRemoveEditedEvent = (indexToRemove) => {
            setEditedEvents(editedEvents.filter((_, index) => index !== indexToRemove));
          };

          // Toggle completion for event in edited case (local state only)
          const handleToggleEditedEventCompletion = (indexToToggle) => {
            const updatedEvents = [...editedEvents];
            if (updatedEvents[indexToToggle]) {
              updatedEvents[indexToToggle].completed = !updatedEvents[indexToToggle].completed;
              setEditedEvents(updatedEvents);
            }
          };


          // Update case (persists all local changes to Firestore)
          const handleUpdateCase = async () => {
            if (!editingCase || !editedCaseName.trim() || !editedAssignee.trim() || !db) {
              showCustomAlert('案件名と担当者は必須です。');
              return;
            }
            try {
              const caseDocRef = window.firebase.doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/cases`, editingCase.id);
              await window.firebase.updateDoc(caseDocRef, {
                name: editedCaseName,
                assignee: editedAssignee,
                status: editedStatus,
                startDate: editedStartDate,
                dueDate: editedDueDate,
                basePrice: editedBasePrice ? parseFloat(editedBasePrice) : 0,
                pdfUrl: editedPdfUrl,
                events: editedEvents, // Save updated event list (including completed status, pdfUrl, and imageUrl)
                updatedAt: window.firebase.serverTimestamp() // Record update timestamp
              });
              closeEditPage(); // Close edit page after update
            } catch (e) {
              console.error("Error updating document: ", e);
              setError("案件の更新に失敗しました。");
            }
          };


          if (!isAuthReady || loading) {
            return (
              <div className="min-h-screen flex items-center justify-center bg-gray-100 text-gray-700">
                <p>読み込み中...</p>
              </div>
            );
          }

          if (error) {
            return (
              <div className="min-h-screen flex items-center justify-center bg-red-100 text-red-700">
                <p>エラーが発生しました: {error}</p>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-100 flex flex-col items-center py-10 px-4 sm:px-6 lg:px-8 font-sans">
              {/* Main Application Content (Login form removed) */}
              {currentView === 'list' && (
                // メインのリストビューコンテンツ
                <div className="max-w-4xl w-full bg-white p-8 rounded-xl shadow-lg">
                  <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">デザイン案件管理</h1>

                  {/* ユーザーID表示 */}
                  <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200 text-sm text-blue-800 flex justify-between items-center">
                    <div>
                      <p className="font-semibold">現在のユーザーID:</p>
                      <p className="break-all">{userId}</p>
                      <p className="mt-2">このIDは、他のユーザーと案件を共有する際に必要になる場合があります。</p>
                    </div>
                  </div>

                  {/* 案件追加フォーム */}
                  <div className="mb-8 p-6 bg-blue-50 rounded-xl shadow-md">
                    <h2 className="text-2xl font-semibold text-blue-700 mb-4">新しい案件を追加</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div>
                        <label htmlFor="newCaseName" className="block text-sm font-medium text-gray-700 mb-1">案件名</label>
                        <input
                          type="text"
                          id="newCaseName"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newCaseName}
                          onChange={(e) => setNewCaseName(e.target.value)}
                          placeholder="例: 株式会社ABC ロゴデザイン"
                        />
                      </div>
                      <div>
                        <label htmlFor="newAssignee" className="block text-sm font-medium text-gray-700 mb-1">担当者</label>
                        <input
                          type="text"
                          id="newAssignee"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newAssignee}
                          onChange={(e) => setNewAssignee(e.target.value)}
                          placeholder="例: 山田太郎"
                        />
                      </div>
                      <div>
                        <label htmlFor="newStartDate" className="block text-sm font-medium text-gray-700 mb-1">開始日</label>
                        <input
                          type="date"
                          id="newStartDate"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newStartDate}
                          onChange={(e) => setNewStartDate(e.target.value)}
                        />
                      </div>
                      <div>
                        <label htmlFor="newDueDate" className="block text-sm font-medium text-gray-700 mb-1">完了予定日</label>
                        <input
                          type="date"
                          id="newDueDate"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newDueDate}
                          onChange={(e) => setNewDueDate(e.target.value)}
                        />
                      </div>
                      <div>
                        <label htmlFor="newStatus" className="block text-sm font-medium text-gray-700 mb-1">ステータス</label>
                        <select
                          id="newStatus"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newStatus}
                          onChange={(e) => setNewStatus(e.target.value)}
                        >
                          <option value="未着手">未着手</option>
                          <option value="進行中">進行中</option>
                          <option value="確認待ち">確認待ち</option>
                          <option value="完了">完了</option>
                          <option value="キャンセル">キャンセル</option>
                        </select>
                      </div>
                      <div>
                        <label htmlFor="newBasePrice" className="block text-sm font-medium text-gray-700 mb-1">基本料金 (円)</label>
                        <input
                          type="number"
                          id="newBasePrice"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newBasePrice}
                          onChange={(e) => setNewBasePrice(e.target.value)}
                          placeholder="例: 50000"
                        />
                      </div>
                      <div className="md:col-span-2">
                        <label htmlFor="newPdfUrl" className="block text-sm font-medium text-gray-700 mb-1">PDF URL (添付用)</label>
                        <input
                          type="url"
                          id="newPdfUrl"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newPdfUrl}
                          onChange={(e) => setNewPdfUrl(e.target.value)}
                          placeholder="例: https://example.com/document.pdf"
                        />
                      </div>
                    </div>

                    {/* タイムラインイベント追加セクション (新規案件用) */}
                    <div className="mb-4 p-4 bg-blue-100 rounded-md">
                      <h3 className="text-lg font-semibold text-blue-800 mb-2">タイムラインイベントを追加</h3>
                      <div className="flex flex-col sm:flex-row gap-2 mb-2">
                        <input
                          type="date"
                          className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newEventDate}
                          onChange={(e) => setNewEventDate(e.target.value)}
                        />
                        <input
                          type="text"
                          className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newEventDescription}
                          onChange={(e) => setNewEventDescription(e.target.value)}
                          placeholder="例: 校正提出済み"
                        />
                        <input
                          type="url"
                          className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newEventPdfUrl}
                          onChange={(e) => setNewEventPdfUrl(e.target.value)}
                          placeholder="イベント関連PDF URL (任意)"
                        />
                        <select
                          className="flex-shrink-0 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newEvent_Type}
                          onChange={(e) => setNewEvent_Type(e.target.value)}
                        >
                          <option value="提出">提出</option> {/* '予定'から'提出'に変更 */}
                          <option value="タスク">タスク</option>
                        </select>
                        <button
                          onClick={handleAddNewEvent}
                          className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition duration-300"
                        >
                          追加
                        </button>
                      </div>
                      <div className="mt-3">
                        {newEvents.length > 0 ? (
                          <ul className="list-disc list-inside text-sm text-gray-700">
                            {newEvents.map((event, index) => (
                              <li key={index} className={`flex justify-between items-center py-1 ${event.completed ? 'line-through text-gray-500' : ''}`}>
                                <span>
                                  [{event.type}] {event.date}: {event.description}
                                  {event.pdfUrl && <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-xs ml-2">PDF</a>}
                                </span>
                                <div>
                                  <button
                                    onClick={() => handleToggleNewEventCompletion(index)}
                                    className={`ml-2 px-2 py-1 rounded-md text-xs font-semibold ${event.completed ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                  >
                                    {event.completed ? '完了済み' : '完了'}
                                  </button>
                                  <button
                                    onClick={() => handleRemoveNewEvent(index)}
                                    className="text-red-500 hover:text-red-700 ml-2"
                                  >
                                    &times;
                                  </button>
                                </div>
                              </li>
                            ))}
                          </ul>
                        ) : (
                          <p className="text-sm text-gray-500">イベントはまだありません。</p>
                        )}
                      </div>
                    </div>

                    <button
                      onClick={handleAddCase}
                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                    >
                      案件を追加
                    </button>
                  </div>

                  {/* 表示モード切り替えボタン */}
                  <div className="mb-6 flex justify-center space-x-4">
                    <button
                      onClick={() => setListDisplayMode('card')}
                      className={`py-2 px-6 rounded-lg font-semibold transition duration-300 ${
                        listDisplayMode === 'card' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      カード表示
                    </button>
                    <button
                      onClick={() => setListDisplayMode('table')}
                      className={`py-2 px-6 rounded-lg font-semibold transition duration-300 ${
                        listDisplayMode === 'table' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      テーブル表示
                    </button>
                    <button
                      onClick={() => setListDisplayMode('timeline')}
                      className={`py-2 px-6 rounded-lg font-semibold transition duration-300 ${
                        listDisplayMode === 'timeline' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      タイムライン表示
                    </button>
                    <button
                      onClick={() => setListDisplayMode('calendar')}
                      className={`py-2 px-6 rounded-lg font-semibold transition duration-300 ${
                        listDisplayMode === 'calendar' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      カレンダー表示
                    </button>
                  </div>

                  {/* 案件リスト / テーブル / タイムライン / カレンダー */}
                  {listDisplayMode === 'card' && (
                    <div className="p-6 bg-white rounded-xl shadow-md">
                      <h2 className="text-2xl font-semibold text-gray-700 mb-4">案件一覧 (カード表示)</h2>
                      {cases.length === 0 ? (
                        <p className="text-gray-500 text-center">案件がありません。新しい案件を追加してください。</p>
                      ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                          {cases.map((caseItem) => (
                            <div key={caseItem.id} className="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col">
                              <h3 className="text-lg font-semibold text-gray-800 mb-2">{caseItem.name}</h3>
                              <p className="text-gray-600 text-sm">担当者: {caseItem.assignee}</p>
                              <p className="text-gray-600 text-sm">ステータス: <span className={`font-medium ${
                                caseItem.status === '完了' ? 'text-green-600' :
                                caseItem.status === '進行中' ? 'text-blue-600' :
                                caseItem.status === '確認待ち' ? 'text-yellow-600' :
                                caseItem.status === 'キャンセル' ? 'text-red-600' : 'text-gray-600'
                              }`}>{caseItem.status}</span></p>
                              {caseItem.startDate && <p className="text-gray-600 text-xs">開始日: {caseItem.startDate}</p>}
                              {caseItem.dueDate && <p className="text-gray-600 text-xs">完了予定日: {caseItem.dueDate}</p>}
                              {caseItem.basePrice > 0 && <p className="text-gray-600 text-xs">基本料金: {caseItem.basePrice.toLocaleString()}円</p>}
                              {caseItem.pdfUrl && (
                                <p className="text-gray-600 text-xs">
                                  PDF: <a href={caseItem.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline break-all">表示</a>
                                </p>
                              )}
                              {caseItem.events && caseItem.events.length > 0 && (
                                <div className="mt-2 text-xs text-gray-600">
                                    <strong>イベント:</strong>
                                    <ul className="list-disc list-inside">
                                        {caseItem.events.map((event, idx) => (
                                            <li key={idx} className={`${event.completed ? 'line-through text-gray-500' : ''}`}>
                                              [{event.type}] {event.date}: {event.description}
                                              {event.pdfUrl && <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-xs ml-2">PDF</a>}
                                            </li>
                                        ))}
                                      </ul>
                                  </div>
                                )}
                                {caseItem.createdAt && (
                                  <p className="text-gray-500 text-xs mt-auto pt-2">
                                    作成日: {new Date(caseItem.createdAt.toDate()).toLocaleString()}
                                  </p>
                                )}
                                {caseItem.createdBy && (
                                  <p className="text-gray-500 text-xs">
                                    作成者ID: <span className="break-all">{caseItem.createdBy}</span>
                                  </p>
                                )}
                                <button
                                  onClick={() => openEditPage(caseItem)} // openEditPage を呼び出す
                                  className="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-sm"
                                >
                                  詳細
                                </button>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    )}

                    {listDisplayMode === 'table' && (
                      <div className="p-6 bg-white rounded-xl shadow-md">
                        <h2 className="text-2xl font-semibold text-gray-700 mb-4">案件一覧 (テーブル表示)</h2>
                        {cases.length === 0 ? (
                          <p className="text-gray-500 text-center">案件がありません。新しい案件を追加してください。</p>
                        ) : (
                          <div className="w-full overflow-x-auto">
                            <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                              <thead>
                                <tr className="bg-gray-100 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider"><th className="py-3 px-4 border-b">案件名</th><th className="py-3 px-4 border-b">担当者</th><th className="py-3 px-4 border-b">ステータス</th><th className="py-3 px-4 border-b">基本料金</th><th className="py-3 px-4 border-b">タスク</th><th className="py-3 px-4 border-b">操作</th></tr>
                              </thead>
                              <tbody>
                                {cases.map((caseItem) => (
                                  <tr key={caseItem.id} className="border-b border-gray-200 hover:bg-gray-50"><td className="py-3 px-4 text-sm text-gray-800 font-semibold">{caseItem.name}</td><td className="py-3 px-4 text-sm text-gray-600">{caseItem.assignee}</td><td className="py-3 px-4 text-sm text-gray-600">
                                      <span className={`font-medium ${
                                        caseItem.status === '完了' ? 'text-green-600' :
                                        caseItem.status === '進行中' ? 'text-blue-600' :
                                        caseItem.status === '確認待ち' ? 'text-yellow-600' :
                                        caseItem.status === 'キャンセル' ? 'text-red-600' : 'text-gray-600'
                                      }`}>{caseItem.status}</span>
                                    </td><td className="py-3 px-4 text-sm text-gray-600">{caseItem.basePrice ? `${caseItem.basePrice.toLocaleString()}円` : '-'}</td><td className="py-3 px-4 text-sm text-gray-600">
                                      {caseItem.events ? caseItem.events.length : 0} {/* イベントの数を表示 */}
                                    </td><td className="py-3 px-4">
                                      <button
                                        onClick={() => openEditPage(caseItem)} // openEditPage を呼び出す
                                        className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-xs"
                                      >
                                        詳細
                                      </button>
                                    </td></tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        )}
                      </div>
                    )}

                    {listDisplayMode === 'timeline' && (
                      <div className="p-6 bg-white rounded-xl shadow-md">
                        <h2 className="text-2xl font-semibold text-gray-700 mb-4">案件一覧 (タイムライン表示)</h2>
                        {/* '完了'ステータスの案件を除外して表示 */}
                        {cases.filter(caseItem => caseItem.status !== '完了').length === 0 ? (
                          <p className="text-gray-500 text-center">表示する案件がありません。</p>
                        ) : (
                          <div className="w-full overflow-x-auto space-y-4"> {/* Changed to div structure */}
                            {cases.filter(caseItem => caseItem.status !== '完了').map((caseItem) => (
                              <div key={caseItem.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                <div className="font-semibold text-gray-800 mb-2">{caseItem.name}</div>
                                <TimelineBar
                                  startDate={caseItem.startDate}
                                  dueDate={caseItem.dueDate}
                                  status={caseItem.status}
                                  events={caseItem.events}
                                />
                                <div className="mt-4 text-right">
                                  <button
                                    onClick={() => openEditPage(caseItem)} // openEditPage を呼び出す
                                    className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-xs"
                                  >
                                    詳細
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    )}

                    {listDisplayMode === 'calendar' && (
                      <ListCalendarView cases={cases} openEditPage={openEditPage} />
                    )}
                  </div>
                )}

                {currentView === 'edit' && editingCase && (
                  // The edit view content should be directly within the main App div's styling
                  <div className="max-w-4xl w-full bg-white p-8 rounded-xl shadow-lg">
                    {/* パンくずリスト */}
                    <nav className="text-sm font-medium text-gray-500 mb-6">
                      <ol className="list-none p-0 inline-flex">
                        <li className="flex items-center">
                          <a href="#" onClick={closeEditPage} className="text-blue-600 hover:text-blue-800">TOP</a>
                          <span className="mx-2">/</span>
                        </li>
                        <li className="flex items-center">
                          <span className="text-gray-700">案件編集</span>
                        </li>
                      </ol>
                    </nav>

                    <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">案件を編集</h1>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div>
                        <label htmlFor="editedCaseName" className="block text-sm font-medium text-gray-700 mb-1">案件名</label>
                        <input
                          type="text"
                          id="editedCaseName"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={editedCaseName}
                          onChange={(e) => setEditedCaseName(e.target.value)}
                        />
                      </div>
                      <div>
                        <label htmlFor="editedAssignee" className="block text-sm font-medium text-gray-700 mb-1">担当者</label>
                        <input
                          type="text"
                          id="editedAssignee"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={editedAssignee}
                          onChange={(e) => setEditedAssignee(e.target.value)}
                        />
                      </div>
                      <div>
                        <label htmlFor="editedStartDate" className="block text-sm font-medium text-gray-700 mb-1">開始日</label>
                        <input
                          type="date"
                          id="editedStartDate"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={editedStartDate}
                          onChange={(e) => setEditedStartDate(e.target.value)}
                        />
                      </div>
                      <div>
                        <label htmlFor="editedDueDate" className="block text-sm font-medium text-gray-700 mb-1">完了予定日</label>
                        <input
                          type="date"
                          id="editedDueDate"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={editedDueDate}
                          onChange={(e) => setEditedDueDate(e.target.value)}
                        />
                      </div>
                      <div>
                        <label htmlFor="editedStatus" className="block text-sm font-medium text-gray-700 mb-1">ステータス</label>
                        <select
                          id="editedStatus"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={editedStatus}
                          onChange={(e) => setEditedStatus(e.target.value)}
                        >
                          <option value="未着手">未着手</option>
                          <option value="進行中">進行中</option>
                          <option value="確認待ち">確認待ち</option>
                          <option value="完了">完了</option>
                          <option value="キャンセル">キャンセル</option>
                        </select>
                      </div>
                      <div>
                        <label htmlFor="editedBasePrice" className="block text-sm font-medium text-gray-700 mb-1">基本料金 (円)</label>
                        <input
                          type="number"
                          id="editedBasePrice"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={editedBasePrice}
                          onChange={(e) => setEditedBasePrice(e.target.value)}
                        />
                      </div>
                      <div className="md:col-span-2">
                        <label htmlFor="editedPdfUrl" className="block text-sm font-medium text-gray-700 mb-1">PDF URL (添付用)</label>
                        <input
                          type="url"
                          id="editedPdfUrl"
                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={editedPdfUrl}
                          onChange={(e) => setEditedPdfUrl(e.target.value)}
                        />
                      </div>
                    </div>

                    {/* タイムラインイベント追加セクション (編集モーダル用) */}
                    <div className="mb-4 p-4 bg-blue-100 rounded-md">
                      <h3 className="text-lg font-semibold text-blue-800 mb-2">タイムラインイベント</h3>
                      <div className="flex flex-col sm:flex-row gap-2 mb-2">
                        <input
                          type="date"
                          className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newEventDate}
                          onChange={(e) => setNewEventDate(e.target.value)}
                        />
                        <input
                          type="text"
                          className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newEventDescription}
                          onChange={(e) => setNewEventDescription(e.target.value)}
                          placeholder="例: 校正提出済み"
                        />
                        <input
                          type="url"
                          className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newEventPdfUrl}
                          onChange={(e) => setNewEventPdfUrl(e.target.value)}
                          placeholder="イベント関連PDF URL (任意)"
                        />
                        <select
                          className="flex-shrink-0 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                          value={newEvent_Type}
                          onChange={(e) => setNewEvent_Type(e.target.value)}
                        >
                          <option value="提出">提出</option> {/* '予定'から'提出'に変更 */}
                          <option value="タスク">タスク</option>
                        </select>
                        <button
                          onClick={handleAddEditedEvent}
                          className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition duration-300"
                        >
                          追加
                        </button>
                      </div>
                      <div className="mt-3">
                        {editedEvents.length > 0 ? (
                          <ul className="list-disc list-inside text-sm text-gray-700">
                            {editedEvents.map((event, index) => (
                              <li key={index} className={`flex justify-between items-center py-1 ${event.completed ? 'line-through text-gray-500' : ''}`}>
                                <span>
                                  [{event.type}] {event.date}: {event.description}
                                  {event.pdfUrl && <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-xs ml-2">PDF</a>}
                                </span>
                                <div>
                                  <button
                                    onClick={() => handleToggleEditedEventCompletion(index)}
                                    className={`ml-2 px-2 py-1 rounded-md text-xs font-semibold ${event.completed ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                  >
                                    {event.completed ? '完了済み' : '完了'}
                                  </button>
                                  <button
                                    onClick={() => handleRemoveEditedEvent(index)}
                                    className="text-red-500 hover:text-red-700 ml-2"
                                  >
                                    &times;
                                  </button>
                                </div>
                              </li>
                            ))}
                          </ul>
                        ) : (
                          <p className="text-sm text-gray-500">イベントはまだありません。</p>
                        )}
                      </div>
                    </div>

                    <button
                      onClick={handleUpdateCase}
                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                    >
                      案件を更新
                    </button>

                    {/* 案件詳細時系列ビュー (編集画面では非表示) */}
                    {editingCase && (
                      <div className="mt-6 p-4 bg-gray-50 rounded-lg shadow-inner">
                        <h3 className="text-lg font-semibold text-gray-700 mb-2 text-center">案件のタイムライン表示</h3>
                        <TimelineBar
                          startDate={editingCase.startDate}
                          dueDate={editingCase.dueDate}
                          status={editingCase.status}
                          events={editedEvents} // 編集中のイベントリストを渡す
                        />
                      </div>
                    )}
                  </div>
                )}

              {/* カスタムアラート */}
              {showAlert && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                  <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">お知らせ</h3>
                    <p className="text-gray-700 mb-6">{alertMessage}</p>
                    <button
                      onClick={() => setShowAlert(false)}
                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out"
                    >
                      閉じる
                    </button>
                  </div>
                </div>
              )}
            </div>
          );
        }

        // App コンポーネントをグローバルスコープで利用可能にする
        // これにより、index.html の <script type="text/babel"> から参照できるようになる
        window.App = App;

        // App コンポーネントが定義された後、ReactDOM.createRoot を使ってAppコンポーネントをレンダリング
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
