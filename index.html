<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>デザイン案件管理</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter (Optional, but recommended for consistent design) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>

    <!-- Firebase Configuration - REPLACE WITH YOUR ACTUAL FIREBASE PROJECT CONFIG -->
    <!-- !!! IMPORTANT: You MUST replace "YOUR_API_KEY", "YOUR_AUTH_DOMAIN", etc. with your actual Firebase project values. -->
    <!-- You can find these values in your Firebase Console under Project settings > General. -->
    <script>
        window.__firebase_config = {
            apiKey: "YOUR_API_KEY", // <-- ここをあなたのAPIキーに置き換えてください
            authDomain: "YOUR_AUTH_DOMAIN", // 例: your-project-id.firebaseapp.com
            projectId: "YOUR_PROJECT_ID", // 例: your-project-id
            storageBucket: "YOUR_STORAGE_BUCKET", // 例: your-project-id.appspot.com
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID" // 例: 1:xxxxxxxxxx:web:xxxxxxxxxxxxxx
        };
        window.__app_id = "YOUR_APP_ID"; // 通常はwindow.__firebase_config.appIdと同じ
    </script>

    <!-- Supabase Configuration -->
    <script>
        window.__supabase_config = {
            supabaseUrl: "https://ntldptsliihnbvzlctdu.supabase.co",
            supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50bGRwdHNsaWlobmJ2emxjdGR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MzcxNzYsImV4cCI6MjA2NTIxMzE3Nn0.h0guPRYtt2cXQa-kHKBVXhhYVgSs_nL2uQS9qWv0rKE"
        };
    </script>

    <!-- Supabase Client Library -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Supabase Client Initialization -->
    <script type="module">
        // Supabaseクライアントの初期化
        const supabase = window.supabase.createClient(
            window.__supabase_config.supabaseUrl,
            window.__supabase_config.supabaseKey
        );

        // グローバルスコープに公開
        window.supabaseClient = supabase;
    </script>

    <!-- React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Your App.js script content directly embedded here -->
    <script type="text/babel">
        // Reactはグローバルスコープからアクセス可能になる
        const { useState, useEffect, useCallback, useRef, useMemo } = React;


        // TimelineBarコンポーネント
        const TimelineBar = ({ startDate, dueDate, status, events = [] }) => {
          if (!startDate || !dueDate) {
            return <div className="text-gray-500 text-xs">日付未設定</div>;
          }

          const start = new Date(startDate);
          const end = new Date(dueDate);
          const today = new Date();

          start.setHours(0, 0, 0, 0);
          end.setHours(0, 0, 0, 0);
          today.setHours(0, 0, 0, 0);

          const totalDurationMs = end.getTime() - start.getTime();

          // ツールチップ表示用のstate
          const [activeTooltipIndex, setActiveTooltipIndex] = useState(null);
          const [showStartTooltip, setShowStartTooltip] = useState(false);
          const [showEndTooltip, setShowEndTooltip] = useState(false);


          // イベントの種類に応じた色を返すヘルパー関数
          const getEventTypeColor = (event) => { // イベントオブジェクト全体を受け取る
            if (event.completed) {
              return 'bg-green-500'; // 完了したイベントは常に緑
            }
            switch (event.type) {
              case '予定': return 'bg-yellow-500';
              case '提出': return 'bg-yellow-500'; // '予定'から'提出'に変更
              case 'タスク': return 'bg-red-500';
              case '完了': return 'bg-green-500'; // '完了'タイプの未完了イベントも緑
              default: return 'bg-purple-600'; // デフォルト色 (未定義の場合)
            }
          };

          // イベントマーカーの位置を計算
          const eventMarkers = events
            .map((event) => {
              const eventDate = new Date(event.date);
              eventDate.setHours(0, 0, 0, 0);
              const eventOffsetMs = eventDate.getTime() - start.getTime();
              let position = 0;
              if (totalDurationMs > 0) {
                position = (eventOffsetMs / totalDurationMs) * 100;
              }
              return {
                ...event,
                position: Math.max(0, Math.min(100, position))
              };
            })
            .sort((a, b) => a.position - b.position); // 位置でソート

          let progressPercentage = 0;
          if (totalDurationMs > 0) {
            const elapsedMs = today.getTime() - start.getTime();
            progressPercentage = (elapsedMs / totalDurationMs) * 100;
            if (progressPercentage < 0) progressPercentage = 0;
            if (progressPercentage > 100) progressPercentage = 100;
          }

          const barColorClass = 'bg-gray-700'; // Dark gray, close to black
          const progressColorClass = status === '完了' ? 'bg-blue-500' : 'bg-green-500';

          // 今日のマーカーの位置を計算
          const todayMarkerPosition = (today.getTime() - start.getTime()) / totalDurationMs * 100;
          let clampedTodayMarkerPosition = Math.max(0, Math.min(100, todayMarkerPosition));

          return (
            <div className="relative w-full h-8 rounded-lg my-1">
              {/* ベースの薄い黒い線 */}
              <div
                className={`absolute top-1/2 -translate-y-1/2 left-0 h-0.5 ${barColorClass} w-full rounded-lg`}
              ></div>

              {/* 進捗バー (緑/青) */}
              {status !== '完了' && (
                <div
                  className={`absolute top-1/2 -translate-y-1/2 left-0 h-0.5 ${progressColorClass} transition-all duration-500 ease-out rounded-lg`}
                  style={{ width: `${progressPercentage}%` }}
                ></div>
              )}

              {/* 今日のマーカー (▼) - ラインの上に表示、黒色 */}
              <div
                className="absolute bottom-full mb-1 h-0 w-0 border-l-[6px] border-r-[6px] border-t-[8px] border-l-transparent border-r-transparent border-t-black z-10"
                style={{ left: `${clampedTodayMarkerPosition}%`, transform: 'translateX(-50%)' }} // 中央に配置
                title="今日"
              ></div>

              {/* 開始日のマーカー */}
              <div
                className="absolute top-1/2 -translate-y-1/2 w-3 h-3 z-20 cursor-pointer"
                style={{ left: `0%`, transform: 'translateX(-50%)' }}
                onMouseEnter={() => setShowStartTooltip(true)}
                onMouseLeave={() => setShowStartTooltip(false)}
              >
                <div className="absolute left-1/2 -translate-x-1/2 w-0.5 h-4 bg-gray-800 -top-2"></div> {/* Vertical line */}
                <div className="absolute left-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-gray-800 -top-4"></div> {/* Small circle */}
                {showStartTooltip && (
                  <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap z-30">
                    <p>開始日: {startDate}</p>
                    <div className="absolute bottom-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-4 border-b-gray-800"></div>
                  </div>
                )}
              </div>

              {/* 完了予定日のマーカー */}
              <div
                className="absolute top-1/2 -translate-y-1/2 w-3 h-3 z-20 cursor-pointer"
                style={{ left: `100%`, transform: 'translateX(-50%)' }}
                onMouseEnter={() => setShowEndTooltip(true)}
                onMouseLeave={() => setShowEndTooltip(false)}
              >
                <div className="absolute left-1/2 -translate-x-1/2 w-0.5 h-4 bg-gray-800 -top-2"></div> {/* Vertical line */}
                <div className="absolute left-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-gray-800 -top-4"></div> {/* Small circle */}
                {showEndTooltip && (
                  <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap z-30">
                    <p>完了予定日: {dueDate}</p>
                    <div className="absolute bottom-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-4 border-b-gray-800"></div>
                  </div>
                )}
              </div>

              {/* イベントマーカー */}
              {eventMarkers.map((event, index) => (
                <div
                  key={index}
                  // タスクの場合は四角、それ以外は丸
                  className={`absolute top-1/2 -translate-y-1/2 w-3 h-3 z-20 cursor-pointer ${getEventTypeColor(event)} ${event.type === 'タスク' ? '' : 'rounded-full'}`}
                  style={{ left: `${event.position}%` }}
                  onMouseEnter={() => setActiveTooltipIndex(index)}
                  onMouseLeave={() => setActiveTooltipIndex(null)}
                  onClick={() => setActiveTooltipIndex(activeTooltipIndex === index ? null : index)} // タップで表示・非表示を切り替え
                >
                  {/* ツールチップ */}
                  {activeTooltipIndex === index && (
                    <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap z-30">
                      <p>{event.date}</p>
                      <p>{event.description}</p>
                      {event.pdfUrl && (
                        <p className="text-xs text-gray-400">
                          PDF: <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-300 hover:underline">表示</a>
                        </p>
                      )}
                      {/* ツールチップのポインター（吹き出しの三角形） */}
                      <div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-4 border-t-gray-800"></div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          );
        };

        // New component for vertical timeline for a single case
        const VerticalCaseTimeline = ({ caseItem, displayStartDate, displayEndDate, heightPerDay, openEditPage, onCaseHover }) => {
          const caseStartDate = new Date(caseItem.startDate);
          const caseDueDate = new Date(caseItem.dueDate);

          // Clamp case start/end dates to display range for visual representation
          const effectiveStartDate = new Date(Math.max(caseStartDate.getTime(), displayStartDate.getTime()));
          const effectiveDueDate = new Date(Math.min(caseDueDate.getTime(), displayEndDate.getTime()));

          // Calculate top position relative to the overall display start date
          const startOffsetDays = (effectiveStartDate.getTime() - displayStartDate.getTime()) / (1000 * 60 * 60 * 24);
          const topPx = Math.max(0, startOffsetDays * heightPerDay);

          // Calculate height based on effective duration within the display range
          const durationDays = (effectiveDueDate.getTime() - effectiveStartDate.getTime()) / (1000 * 60 * 60 * 24) + 1;
          const heightPx = Math.max(0, durationDays * heightPerDay);

          if (heightPx <= 0) return null;

          const sortedEvents = [...(caseItem.events || [])].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

          const getEventTypeShapeClass = (event) => {
            switch (event.type) {
              case 'タスク': return ''; // Square for task
              default: return 'rounded-full'; // Circle for others
            }
          };

          const getEventColorClass = (event) => {
            if (event.completed) {
              return 'bg-green-500';
            }
            switch (event.type) {
              case '予定': return 'bg-yellow-500';
              case '提出': return 'bg-yellow-500'; // '予定'から'提出'に変更
              case 'タスク': return 'bg-red-500';
              case '完了': return 'bg-green-500';
              default: return 'bg-purple-600';
            }
          };

          const [activeTooltipIndex, setActiveTooltipIndex] = useState(null); // For event tooltips

          return (
            <div
              className="absolute w-0.5 bg-gray-800 flex flex-col items-center cursor-pointer" // 黒の細い線に変更, cursor-pointerを追加
              style={{ top: `${topPx}px`, height: `${heightPx}px`, /* Horizontal positioning will be handled by parent */ }}
              onClick={() => openEditPage(caseItem)} // 黒ライン全体をクリック可能に
              onMouseEnter={() => onCaseHover(caseItem)} // マウスオーバーで案件情報を親に渡す
              onMouseLeave={() => onCaseHover(null)} // マウスアウトで情報をクリア
            >
              {/* 開始日マーカー (ツールチップなし) */}
              <div
                className="absolute w-3 h-3 bg-black rounded-full z-20"
                style={{ top: '0px', transform: 'translateY(-50%) translateX(-50%)', left: '50%' }}
              ></div>

              {/* 完了予定日マーカー (ツールチップなし) */}
              <div
                className="absolute w-3 h-3 bg-black rounded-full z-20"
                style={{ bottom: '0px', transform: 'translateY(50%) translateX(-50%)', left: '50%' }}
              ></div>

              {/* Events on this case's timeline */}
              {sortedEvents.map((event, eventIdx) => {
                const eventDate = new Date(event.date);
                // Position event relative to the effective start date of the case's visible timeline
                const eventOffsetDays = (eventDate.getTime() - effectiveStartDate.getTime()) / (1000 * 60 * 60 * 24);
                const eventTopPx = eventOffsetDays * heightPerDay;

                // Only show event if it.falls within the visible portion of the case timeline
                if (eventTopPx < 0 || eventTopPx > heightPx) return null;

                return (
                  <div
                    key={eventIdx}
                    className={`absolute w-3 h-3 z-20 cursor-pointer ${getEventColorClass(event)} ${getEventTypeShapeClass(event)}`} // 形状と色を適用
                    style={{ top: `${eventTopPx}px`, left: '50%', transform: 'translateX(-50%) translateY(-50%)' }} // 線の上に中央配置
                    onMouseEnter={() => setActiveTooltipIndex(eventIdx)}
                    onMouseLeave={() => setActiveTooltipIndex(null)}
                  >
                    {/* ツールチップ */}
                    {activeTooltipIndex === eventIdx && (
                      <div className="absolute left-1/2 -translate-x-1/2 mt-2 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg whitespace-nowrap z-30" style={{ top: '100%' }}>
                        <p>{event.date}</p>
                        <p>{event.description}</p>
                        {event.pdfUrl && (
                          <p className="text-xs text-gray-400">
                            PDF: <a href={event.pdfUrl} target="_blank" rel="noopener noreferrer" className="text-blue-300 hover:underline">表示</a>
                          </p>
                        )}
                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-b-4 border-b-gray-800"></div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          );
        };


        const ListCalendarView = ({ cases, openEditPage }) => { // openEditPage を受け取る
          const scrollContainerRef = useRef(null);
          const heightPerDay = 20; // 1日あたりの高さ (px)を20pxに変更
          const [loadedDaysBefore, setLoadedDaysBefore] = useState(15); // 今日から過去に読み込む日数
          const [loadedDaysAfter, setLoadedDaysAfter] = useState(15);  // 今日から未来に読み込む日数
          const loadIncrement = 30; // 一度に読み込む日付の増分
          const [hoveredCaseInfo, setHoveredCaseInfo] = useState(null); // ホバー中の案件情報を保持するstate

          const today = useMemo(() => { // todayをメモ化
            const d = new Date();
            d.setHours(0, 0, 0, 0);
            return d;
          }, []);

          // 表示開始日と表示終了日を計算 (useMemoでメモ化)
          const displayStartDate = useMemo(() => {
            const d = new Date(today);
            d.setDate(today.getDate() - loadedDaysBefore);
            return d;
          }, [today, loadedDaysBefore]);

          const displayEndDate = useMemo(() => {
            const d = new Date(today);
            d.setDate(today.getDate() + loadedDaysAfter);
            return d;
          }, [today, loadedDaysAfter]);

          const datesToDisplay = useMemo(() => {
            const dates = [];
            let loopDate = new Date(displayStartDate);
            while (loopDate <= displayEndDate) {
              dates.push(new Date(loopDate));
              loopDate.setDate(loopDate.getDate() + 1);
            }
            return dates;
          }, [displayStartDate, displayEndDate]); // Dependencies for useMemo

          const totalContentHeight = datesToDisplay.length * heightPerDay; // 全日付のコンテンツに必要な合計高さ

          // ファーストビューで表示したい日数を設定
          const firstViewDays = 31; // 31日をファーストビューで表示
          const firstViewHeight = firstViewDays * heightPerDay; // 31日分の高さ

          // 初期ロード時に今日の日付が中央に来るようにスクロール
          useEffect(() => {
            if (scrollContainerRef.current) {
              const todayIndex = datesToDisplay.findIndex(date => date.toDateString() === today.toDateString());
              if (todayIndex !== -1) {
                // 今日がスクロールコンテナの中央に来るように計算
                const scrollToY = (todayIndex * heightPerDay) - (scrollContainerRef.current.clientHeight / 2) + (heightPerDay / 2);
                scrollContainerRef.current.scrollTop = Math.max(0, scrollToY);
              }
            }
          }, [datesToDisplay, today, heightPerDay, firstViewHeight]);

          // スクロールイベントハンドラ
          const handleScroll = useCallback(() => {
            const { scrollTop, scrollHeight, clientHeight } = scrollContainerRef.current;
            const scrollThreshold = 50; // スクロール端からの距離（px）

            // 上端にスクロールしたか
            if (scrollTop < scrollThreshold) {
              const oldScrollHeight = scrollHeight;
              setLoadedDaysBefore(prev => prev + loadIncrement);
              // 新しいコンテンツが追加された後にスクロール位置を調整
              requestAnimationFrame(() => {
                if (scrollContainerRef.current) {
                  scrollContainerRef.current.scrollTop = scrollContainerRef.current.scrollHeight - oldScrollHeight;
                }
              });
            }

            // 下端にスクロールしたか
            if (scrollTop + clientHeight > scrollHeight - scrollThreshold) {
              setLoadedDaysAfter(prev => prev + loadIncrement);
            }
          }, [loadIncrement]);

          // スクロールイベントリスナーの追加とクリーンアップ
          useEffect(() => {
            const currentRef = scrollContainerRef.current;
            if (currentRef) {
              currentRef.addEventListener('scroll', handleScroll);
            }
            return () => {
              if (currentRef) {
                currentRef.removeEventListener('scroll', handleScroll);
              }
            };
          }, [handleScroll]);


          // Filter cases that have a valid date range, overlap with the display range, and are not '完了'
          const visibleCases = cases.filter(caseItem =>
            caseItem.startDate && caseItem.dueDate &&
            new Date(caseItem.dueDate) >= displayStartDate &&
            new Date(caseItem.startDate) <= displayEndDate &&
            caseItem.status !== '完了' // '完了'ステータスの案件を除外
          );

          // カレンダー表示の横幅を動的に計算
          const dateColumnWidth = 96; // w-24 = 96px
          const caseColumnWidth = 100; // 各案件の縦ラインが占める幅 (詳細ボタン含む)
          const minContentWidth = dateColumnWidth + (visibleCases.length * caseColumnWidth) + 50; // 案件数に応じて幅を調整 + パディング

          // 日付をYY.MM/DD形式でフォーマットするヘルパー関数
          const formatDateToYYMMDD = (date) => {
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}.${month}/${day}`;
          };

          // ホバーイベントハンドラ
          const handleCaseHover = (caseItem) => {
            setHoveredCaseInfo(caseItem);
          };

          return (
            <div className="p-6 bg-white rounded-xl shadow-md">
              <h2 className="text-2xl font-semibold text-gray-700 mb-4 text-center">カレンダー表示 (縦型タイムライン)</h2>

              {/* メインのスクロールコンテナ */}
              <div
                ref={scrollContainerRef}
                className="relative flex-grow overflow-y-scroll overflow-x-auto border border-gray-200 rounded-lg" // スクロールを統合
                style={{ maxHeight: `${firstViewHeight}px` }}
              >
                <div className="relative" style={{ minHeight: `${totalContentHeight}px`, minWidth: `${minContentWidth}px` }}> {/* 全コンテンツのラッパー */}

                  {/* Date Labels and Horizontal Lines */}
                  {datesToDisplay.map((date, index) => {
                    const isToday = date.toDateString() === today.toDateString();
                    const topPosition = index * heightPerDay;
                    return (
                      <div
                        key={date.toISOString()} // ユニークなキーとしてISO文字列を使用
                        className={`absolute w-full flex items-center border-b border-gray-200 ${isToday ? 'bg-red-50' : ''}`}
                        style={{ top: `${topPosition}px`, height: `${heightPerDay}px` }}
                      >
                        {/* Date label */}
                        <div className={`w-24 text-xs text-center flex-shrink-0 ${isToday ? 'font-bold text-blue-700' : 'text-gray-600'}`}>
                          {formatDateToYYMMDD(date)}
                        </div>
                        {/* 案件のタイムラインが表示される領域 (右側) は、この行の残りの部分に暗黙的に含まれる */}
                      </div>
                    );
                  })}

                  {/* Render each case's vertical timeline */}
                  {visibleCases.map((caseItem, index) => {
                    // Calculate horizontal offset for each case timeline to avoid overlap
                    const dateColumnWidth = 96; // w-24 = 96px
                    const horizontalOffset = index * caseColumnWidth; // 各案件に100px幅の"トラック"を割り当て
                    const adjustedLeft = dateColumnWidth + horizontalOffset + 20; // 日付列の幅 + 案件トラック + パディング

                    return (
                      <div
                        key={caseItem.id}
                        className="absolute"
                        style={{
                          left: `${adjustedLeft}px`,
                          width: `${caseColumnWidth}px`, // 案件名を表示するために親の幅を確保
                          height: '100%', // 親スクロールエリアの全高を取る
                        }}
                      >
                        <VerticalCaseTimeline
                          caseItem={caseItem}
                          displayStartDate={displayStartDate}
                          displayEndDate={displayEndDate}
                          heightPerDay={heightPerDay}
                          openEditPage={openEditPage}
                          onCaseHover={handleCaseHover} // ホバーイベントを親に伝える
                        />
                        {/* Removed 案件名を欄外の枠の左下に表示 from here */}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* ホバーされた案件情報を表示するエリア */}
              <div className="mt-4 p-3 bg-gray-100 rounded-lg border border-gray-200 w-full text-left">
                {hoveredCaseInfo ? (
                  <div className="text-gray-800 text-sm">
                    <p className="font-semibold">案件名: {hoveredCaseInfo.name}</p>
                    <p>開始日: {hoveredCaseInfo.startDate || '-'}</p>
                    <p>完了予定日: {hoveredCaseInfo.dueDate || '-'}</p>
                    <p>ステータス: {hoveredCaseInfo.status}</p>
                  </div>
                ) : (
                  <p className="text-gray-500 text-sm">案件ラインにマウスを合わせると詳細が表示されます。</p>
                )}
              </div>
            </div>
          );
        };


        function App() {
            // Supabase関連のstate
            const [supabaseClient, setSupabaseClient] = useState(null);
            const [userId, setUserId] = useState('');
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // 案件データと入力フォームのstate
            const [cases, setCases] = useState([]);
            const [newCaseName, setNewCaseName] = useState('');
            const [newAssignee, setNewAssignee] = useState('');
            const [newStatus, setNewStatus] = useState('未着手');
            const [newStartDate, setNewStartDate] = useState('');
            const [newDueDate, setNewDueDate] = useState('');
            const [newBasePrice, setNewBasePrice] = useState('');
            const [newPdfUrl, setNewPdfUrl] = useState('');
            const [newEvents, setNewEvents] = useState([]);
            const [newEventDate, setNewEventDate] = useState('');
            const [newEventDescription, setNewEventDescription] = useState('');
            const [newEvent_Type, setNewEvent_Type] = useState('提出');
            const [newEventPdfUrl, setNewEventPdfUrl] = useState('');

            // 編集関連のstate
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);
            const [editingCase, setEditingCase] = useState(null);
            const [editedCaseName, setEditedCaseName] = useState('');
            const [editedAssignee, setEditedAssignee] = useState('');
            const [editedStatus, setEditedStatus] = useState('');
            const [editedStartDate, setEditedStartDate] = useState('');
            const [editedDueDate, setEditedDueDate] = useState('');
            const [editedBasePrice, setEditedBasePrice] = useState('');
            const [editedPdfUrl, setEditedPdfUrl] = useState('');
            const [editedEvents, setEditedEvents] = useState([]);

            // ビュー関連のstate
            const [currentView, setCurrentView] = useState('list');
            const [listDisplayMode, setListDisplayMode] = useState('calendar');

            // アラート関連のstate
            const [showAlert, setShowAlert] = useState(false);
            const [alertMessage, setAlertMessage] = useState('');

            // アラート表示関数
            const showCustomAlert = (message) => {
                setAlertMessage(message);
                setShowAlert(true);
            };

            // 初期化と認証
            useEffect(() => {
                try {
                    if (!window.supabaseClient) {
                        throw new Error("Supabaseクライアントが初期化されていません。");
                    }

                    setSupabaseClient(window.supabaseClient);
                    
                    // 認証
                    const signIn = async () => {
                        try {
                            // メール/パスワードでサインイン
                            const { data: { user }, error } = await window.supabaseClient.auth.signInWithPassword({
                                email: 'test@example.com',
                                password: 'test123456'
                            });
                            
                            if (error) {
                                // ユーザーが存在しない場合は新規作成
                                const { data: { user: newUser }, error: signUpError } = await window.supabaseClient.auth.signUp({
                                    email: 'test@example.com',
                                    password: 'test123456',
                                    options: {
                                        data: {
                                            name: 'Test User'
                                        }
                                    }
                                });
                                
                                if (signUpError) throw signUpError;
                                setUserId(newUser.id);
                            } else {
                                setUserId(user.id);
                            }
                            
                            setIsAuthReady(true);
                            setLoading(false);
                        } catch (err) {
                            console.error("認証に失敗しました:", err);
                            setError("認証に失敗しました。");
                            setLoading(false);
                        }
                    };

                    signIn();
                } catch (err) {
                    console.error("Supabase初期化エラー:", err);
                    setError("Supabaseの初期化に失敗しました。");
                    setLoading(false);
                }
            }, []);

            // リアルタイムデータ取得
            useEffect(() => {
                if (supabaseClient && isAuthReady && userId) {
                    setError(null);

                    // リアルタイムサブスクリプションの設定
                    const subscription = supabaseClient
                        .channel('cases_changes')
                        .on(
                            'postgres_changes',
                            {
                                event: '*',
                                schema: 'public',
                                table: 'cases'
                            },
                            (payload) => {
                                // データが変更されたときに全データを再取得
                                fetchCases();
                            }
                        )
                        .subscribe();

                    // 初期データ取得
                    fetchCases();

                    return () => {
                        subscription.unsubscribe();
                    };
                }
            }, [supabaseClient, isAuthReady, userId]);

            // ローディング中または認証準備中の場合
            if (!isAuthReady || loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                            <p className="mt-4">読み込み中...</p>
                        </div>
                    </div>
                );
            }

            // エラーがある場合
            if (error) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-center text-red-600">
                            <p>エラーが発生しました：{error}</p>
                        </div>
                    </div>
                );
            }

            // イベント追加関数
            const handleAddNewEvent = () => {
                if (newEventDate && newEventDescription && newEvent_Type) {
                    setNewEvents([...newEvents, {
                        date: newEventDate,
                        description: newEventDescription,
                        type: newEvent_Type,
                        pdfUrl: newEventPdfUrl,
                        completed: false
                    }]);
                    setNewEventDate('');
                    setNewEventDescription('');
                    setNewEvent_Type('提出');
                    setNewEventPdfUrl('');
                } else {
                    showCustomAlert('イベントの日付、内容、種類は必須です。');
                }
            };

            // イベント削除関数
            const handleRemoveNewEvent = (indexToRemove) => {
                setNewEvents(newEvents.filter((_, i) => i !== indexToRemove));
            };

            // 編集ページを開く関数
            const openEditPage = (caseItem) => {
                setEditingCase(caseItem);
                setEditedCaseName(caseItem.name);
                setEditedAssignee(caseItem.assignee);
                setEditedStatus(caseItem.status);
                setEditedStartDate(caseItem.startDate || '');
                setEditedDueDate(caseItem.dueDate || '');
                setEditedBasePrice(caseItem.basePrice || '');
                setEditedPdfUrl(caseItem.pdfUrl || '');
                setEditedEvents(caseItem.events || []);
                setCurrentView('edit');
            };

            // 案件データの取得
            const fetchCases = async () => {
                try {
                    const { data, error } = await supabaseClient
                        .from('cases')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    setCases(data);
                } catch (err) {
                    console.error("案件データの取得に失敗しました:", err);
                    setError("案件データの取得に失敗しました。");
                }
            };

            // 新規案件の追加
            const handleAddCase = async () => {
                if (!newCaseName.trim() || !newAssignee.trim() || !supabaseClient) {
                    showCustomAlert('案件名と担当者は必須です。');
                    return;
                }
                try {
                    const { error } = await supabaseClient
                        .from('cases')
                        .insert([{
                            name: newCaseName,
                            assignee: newAssignee,
                            status: newStatus,
                            start_date: newStartDate,
                            due_date: newDueDate,
                            base_price: newBasePrice ? parseFloat(newBasePrice) : 0,
                            pdf_url: newPdfUrl,
                            events: newEvents,
                            created_by: userId
                        }]);

                    if (error) throw error;

                    // フォームのクリア
                    setNewCaseName('');
                    setNewAssignee('');
                    setNewStatus('未着手');
                    setNewStartDate('');
                    setNewDueDate('');
                    setNewBasePrice('');
                    setNewPdfUrl('');
                    setNewEvents([]);
                    setNewEventDate('');
                    setNewEventDescription('');
                    setNewEvent_Type('提出');
                    setNewEventPdfUrl('');
                } catch (e) {
                    console.error("案件の追加に失敗しました:", e);
                    setError("案件の追加に失敗しました。");
                }
            };

            return (
                <div className="container mx-auto px-4 py-8">
                    <h1 className="text-3xl font-bold mb-8">案件管理アプリ</h1>
                    
                    {/* 表示モード切り替えボタン */}
                    <div className="mb-6 flex space-x-4">
                        <button
                            onClick={() => setListDisplayMode('card')}
                            className={`px-4 py-2 rounded ${listDisplayMode === 'card' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                        >
                            カード表示
                        </button>
                        <button
                            onClick={() => setListDisplayMode('table')}
                            className={`px-4 py-2 rounded ${listDisplayMode === 'table' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                        >
                            テーブル表示
                        </button>
                        <button
                            onClick={() => setListDisplayMode('timeline')}
                            className={`px-4 py-2 rounded ${listDisplayMode === 'timeline' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                        >
                            タイムライン表示
                        </button>
                        <button
                            onClick={() => setListDisplayMode('calendar')}
                            className={`px-4 py-2 rounded ${listDisplayMode === 'calendar' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                        >
                            カレンダー表示
                        </button>
                    </div>

                    {/* 新規案件追加フォーム */}
                    <div className="mb-8 p-4 bg-white rounded-lg shadow">
                        <h2 className="text-xl font-semibold mb-4">新規案件追加</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">案件名</label>
                                <input
                                    type="text"
                                    value={newCaseName}
                                    onChange={(e) => setNewCaseName(e.target.value)}
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">担当者</label>
                                <input
                                    type="text"
                                    value={newAssignee}
                                    onChange={(e) => setNewAssignee(e.target.value)}
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">ステータス</label>
                                <select
                                    value={newStatus}
                                    onChange={(e) => setNewStatus(e.target.value)}
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                >
                                    <option value="未着手">未着手</option>
                                    <option value="進行中">進行中</option>
                                    <option value="完了">完了</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">開始日</label>
                                <input
                                    type="date"
                                    value={newStartDate}
                                    onChange={(e) => setNewStartDate(e.target.value)}
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">期限</label>
                                <input
                                    type="date"
                                    value={newDueDate}
                                    onChange={(e) => setNewDueDate(e.target.value)}
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">基本料金</label>
                                <input
                                    type="number"
                                    value={newBasePrice}
                                    onChange={(e) => setNewBasePrice(e.target.value)}
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">PDF URL</label>
                                <input
                                    type="text"
                                    value={newPdfUrl}
                                    onChange={(e) => setNewPdfUrl(e.target.value)}
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                />
                            </div>
                        </div>

                        {/* イベント追加フォーム */}
                        <div className="mt-4">
                            <h3 className="text-lg font-medium mb-2">イベント追加</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">日付</label>
                                    <input
                                        type="date"
                                        value={newEventDate}
                                        onChange={(e) => setNewEventDate(e.target.value)}
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">内容</label>
                                    <input
                                        type="text"
                                        value={newEventDescription}
                                        onChange={(e) => setNewEventDescription(e.target.value)}
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">種類</label>
                                    <select
                                        value={newEvent_Type}
                                        onChange={(e) => setNewEvent_Type(e.target.value)}
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    >
                                        <option value="提出">提出</option>
                                        <option value="修正">修正</option>
                                        <option value="確認">確認</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">PDF URL</label>
                                    <input
                                        type="text"
                                        value={newEventPdfUrl}
                                        onChange={(e) => setNewEventPdfUrl(e.target.value)}
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    />
                                </div>
                            </div>
                            <button
                                onClick={handleAddNewEvent}
                                className="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                            >
                                イベント追加
                            </button>
                        </div>

                        {/* イベントリスト */}
                        {newEvents.length > 0 && (
                            <div className="mt-4">
                                <h3 className="text-lg font-medium mb-2">追加されたイベント</h3>
                                <div className="space-y-2">
                                    {newEvents.map((event, index) => (
                                        <div key={index} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                                            <div>
                                                <span className="font-medium">{event.date}</span>
                                                <span className="mx-2">-</span>
                                                <span>{event.description}</span>
                                                <span className="mx-2">({event.type})</span>
                                            </div>
                                            <button
                                                onClick={() => handleRemoveNewEvent(index)}
                                                className="text-red-500 hover:text-red-700"
                                            >
                                                削除
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <button
                            onClick={handleAddCase}
                            className="mt-4 px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                        >
                            案件を追加
                        </button>
                    </div>

                    {/* 案件一覧 */}
                    <div className="bg-white rounded-lg shadow">
                        <h2 className="text-xl font-semibold p-4 border-b">案件一覧</h2>
                        {listDisplayMode === 'card' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                                {cases.map((caseItem) => (
                                    <div key={caseItem.id} className="border rounded-lg p-4">
                                        <h3 className="text-lg font-medium">{caseItem.name}</h3>
                                        <p className="text-gray-600">担当者: {caseItem.assignee}</p>
                                        <p className="text-gray-600">ステータス: {caseItem.status}</p>
                                        <button
                                            onClick={() => openEditPage(caseItem)}
                                            className="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                                        >
                                            編集
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}

                        {listDisplayMode === 'table' && (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">案件名</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">担当者</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ステータス</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {cases.map((caseItem) => (
                                            <tr key={caseItem.id}>
                                                <td className="px-6 py-4 whitespace-nowrap">{caseItem.name}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">{caseItem.assignee}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">{caseItem.status}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <button
                                                        onClick={() => openEditPage(caseItem)}
                                                        className="text-blue-600 hover:text-blue-900"
                                                    >
                                                        編集
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {listDisplayMode === 'timeline' && (
                            <div className="p-4">
                                {cases.map((caseItem) => (
                                    <div key={caseItem.id} className="mb-8">
                                        <div className="flex items-center">
                                            <div className="flex-shrink-0">
                                                <div className="w-4 h-4 bg-blue-500 rounded-full"></div>
                                            </div>
                                            <div className="ml-4">
                                                <h3 className="text-lg font-medium">{caseItem.name}</h3>
                                                <p className="text-gray-600">担当者: {caseItem.assignee}</p>
                                                <p className="text-gray-600">ステータス: {caseItem.status}</p>
                                                <button
                                                    onClick={() => openEditPage(caseItem)}
                                                    className="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                                                >
                                                    編集
                                                </button>
                                            </div>
                                        </div>
                                        {caseItem.events && caseItem.events.length > 0 && (
                                            <div className="ml-8 mt-4 space-y-4">
                                                {caseItem.events.map((event, index) => (
                                                    <div key={index} className="flex items-start">
                                                        <div className="flex-shrink-0">
                                                            <div className="w-2 h-2 bg-gray-400 rounded-full mt-2"></div>
                                                        </div>
                                                        <div className="ml-4">
                                                            <p className="text-sm text-gray-600">{event.date}</p>
                                                            <p className="text-sm">{event.description}</p>
                                                            <p className="text-xs text-gray-500">{event.type}</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {listDisplayMode === 'calendar' && (
                            <div className="p-4">
                                <div className="grid grid-cols-7 gap-2">
                                    {['日', '月', '火', '水', '木', '金', '土'].map((day) => (
                                        <div key={day} className="text-center font-medium p-2">
                                            {day}
                                        </div>
                                    ))}
                                    {Array.from({ length: 35 }, (_, i) => {
                                        const date = new Date();
                                        date.setDate(date.getDate() - date.getDay() + i);
                                        const dateStr = date.toISOString().split('T')[0];
                                        const caseItems = cases.filter(
                                            (caseItem) =>
                                                caseItem.startDate === dateStr ||
                                                caseItem.dueDate === dateStr ||
                                                (caseItem.events && caseItem.events.some((event) => event.date === dateStr))
                                        );

                                        return (
                                            <div
                                                key={i}
                                                className="border p-2 min-h-[100px] hover:bg-gray-50"
                                            >
                                                <div className="text-sm text-gray-500">{date.getDate()}</div>
                                                {caseItems.map((caseItem) => (
                                                    <div
                                                        key={caseItem.id}
                                                        className="text-xs p-1 mt-1 bg-blue-100 rounded cursor-pointer"
                                                        onClick={() => openEditPage(caseItem)}
                                                    >
                                                        {caseItem.name}
                                                    </div>
                                                ))}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* アラート */}
                    {showAlert && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                            <div className="bg-white p-4 rounded-lg shadow-lg">
                                <p>{alertMessage}</p>
                                <button
                                    onClick={() => setShowAlert(false)}
                                    className="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                                >
                                    閉じる
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // App コンポーネントをグローバルスコープで利用可能にする
        // これにより、index.html の <script type="text/babel"> から参照できるようになる
        window.App = App;

        // App コンポーネントが定義された後、ReactDOM.createRoot を使ってAppコンポーネントをレンダリング
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
